events {}

http {

    client_header_timeout 60s;
    client_body_timeout 60s;
    keepalive_timeout 60s;
    send_timeout 60s;

    log_format custom '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'server_name="$host" request_time=$request_time '
                      'upstream_response_time=$upstream_response_time '
                      'upstream_status=$upstream_status';

    access_log /var/log/nginx/access.log custom;

    # ===================================================
    # ERROR page
    # --------------------------------------------------
    server {
        listen 443 ssl default_server;
        # http2 on;
        server_name _;

        ssl_certificate /etc/letsencrypt/live/iotserver.uz/fullchain.pem; # SSL Certificate
        ssl_certificate_key /etc/letsencrypt/live/iotserver.uz/privkey.pem; # SSL Certificate Key

        return 501;  # or use 'error_page' to show a custom error page
    }

    # --------------------------------------------------
    server {
        listen 80 default_server;
        server_name _;

        return 501; # or use 'error_page' to show a custom error page
    }
    

    #===================================================
    # WWW.iotserver.uz
    #--------------------------------------------------
    server {
        listen 443 ssl;
        # http2 on;
        server_name iotserver.uz www.iotserver.uz;

        ssl_certificate /etc/letsencrypt/live/iotserver.uz/fullchain.pem; # SSL Certificate
        ssl_certificate_key /etc/letsencrypt/live/iotserver.uz/privkey.pem; # SSL Certificate Key

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://mainserver:3000;
            # proxy_pass http://localhost:3000;
            # proxy_pass http://172.17.0.1:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        error_page 502 503 504 =501 /custom_50x;

        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

    #--------------------------------------------------
    server {
        listen 80;
        server_name www.iotserver.uz iotserver.uz;

        location / {
            proxy_pass http://mainserver:3000;
            # proxy_pass http://localhost:3000;
            # proxy_pass http://172.17.0.1:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Define a custom error page for 502, 503, and 504 errors
        error_page 502 503 504 =501 /custom_50x;

        # This location block is used to handle the custom error page
        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }

        # location /.well-known/acme-challenge/Mq_sFL0OtGUaI-VhehF3jQKMhSfG9CsW8gVY3jTeNaw {
        #     alias /etc/nginx/cert_file;
        #     default_type text/plain;
        # }
    }

    #===================================================
    # SPEAKER.iotserver.uz
    #--------------------------------------------------
    server {
        listen 443 ssl;
        # http2 on;
        server_name speaker.iotserver.uz;

        ssl_certificate /etc/letsencrypt/live/iotserver.uz/fullchain.pem; # SSL Certificate
        ssl_certificate_key /etc/letsencrypt/live/iotserver.uz/privkey.pem; # SSL Certificate Key

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://speaker:3001;
            # proxy_pass http://localhost:3001;
            # proxy_pass http://172.17.0.1:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        error_page 502 503 504 =501 /custom_50x;

        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

    #--------------------------------------------------
    server {
        listen 80;
        server_name speaker.iotserver.uz;

        location / {
            proxy_pass http://speaker:3001;
            # proxy_pass http://localhost:3001;
            # proxy_pass http://172.17.0.1:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Define a custom error page for 502, 503, and 504 errors
        error_page 502 503 504 =501 /custom_50x;

        # This location block is used to handle the custom error page
        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

    #===================================================
    # WLM.iotserver.uz
    #--------------------------------------------------
    server {
        listen 443 ssl;
        # http2 on;
        server_name wlm.iotserver.uz;

        ssl_certificate /etc/letsencrypt/live/iotserver.uz/fullchain.pem; # SSL Certificate
        ssl_certificate_key /etc/letsencrypt/live/iotserver.uz/privkey.pem; # SSL Certificate Key

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://waterlevel:3002;
            # proxy_pass http://localhost:3002;
            # proxy_pass http://172.17.0.1:3002;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        error_page 502 503 504 =501 /custom_50x;

        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

    #--------------------------------------------------
    server {
        listen 80;
        server_name wlm.iotserver.uz myserveruzb.ddns.net;

        location / {
            proxy_pass http://waterlevel:3002;
            # proxy_pass http://localhost:3002;
            # proxy_pass http://172.17.0.1:3002;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # proxy_set_header Connection "close";
            # keepalive_timeout 0;
        }

        # Define a custom error page for 502, 503, and 504 errors
        error_page 502 503 504 =501 /custom_50x;

        # This location block is used to handle the custom error page
        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

    #===================================================
    # WLMAPI.iotserver.uz
    #--------------------------------------------------
    server {
        listen 443 ssl;
        # http2 on;
        server_name wlmapi.iotserver.uz;

        ssl_certificate /etc/letsencrypt/live/iotserver.uz/fullchain.pem; # SSL Certificate
        ssl_certificate_key /etc/letsencrypt/live/iotserver.uz/privkey.pem; # SSL Certificate Key

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://waterlevel-api:51000;
            # proxy_pass http://localhost:51000;
            # proxy_pass http://172.17.0.1:51000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Retry another upstream if the primary fails
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;

            # Timeout settings
            proxy_connect_timeout 5s;
            proxy_read_timeout 10s;
            proxy_send_timeout 10s;
        }

        # Serve a fallback page if the API is unavailable
        error_page 502 503 504 /fallback.html;

        location = /fallback.html {
            root /usr/share/nginx/html; # Adjust based on your setup
            internal;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

    #--------------------------------------------------
    server {
        listen 80;
        server_name wlmapi.iotserver.uz;

        location / {
            proxy_pass http://waterlevel-api:51000;
            # proxy_pass http://localhost:51000;
            # proxy_pass http://172.17.0.1:51000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # proxy_set_header Connection "close";
            # keepalive_timeout 0;

            # Retry another upstream if the primary fails
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;

            # Timeout settings
            proxy_connect_timeout 5s;
            proxy_read_timeout 10s;
            proxy_send_timeout 10s;
        }

        # Serve a fallback page if the API is unavailable
        error_page 502 503 504 /fallback.html;

        location = /fallback.html {
            root /usr/share/nginx/html; # Adjust based on your setup
            internal;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

     #===================================================
    # WLMTEST.iotserver.uz
    #--------------------------------------------------
    server {
        listen 443 ssl;
        # http2 on;
        server_name wlmtest.iotserver.uz;

        ssl_certificate /etc/letsencrypt/live/iotserver.uz/fullchain.pem; # SSL Certificate
        ssl_certificate_key /etc/letsencrypt/live/iotserver.uz/privkey.pem; # SSL Certificate Key

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://waterleveltest:4001;
            # proxy_pass http://wlmtest:5000;
            # proxy_pass http://172.17.0.1:6000;
            # proxy_pass http://localhost:6000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        error_page 502 503 504 =501 /custom_50x;

        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

    #--------------------------------------------------
    server {
        listen 80;
        server_name wlmtest.iotserver.uz;

        location / {
            proxy_pass http://waterleveltest:4001;
            # proxy_pass http://wlmtest:5000;
            # proxy_pass http://172.17.0.1:6000;
            # proxy_pass http://localhost:6000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # proxy_set_header Connection "close";
            # keepalive_timeout 0;
        }

        # Define a custom error page for 502, 503, and 504 errors
        error_page 502 503 504 =501 /custom_50x;

        # This location block is used to handle the custom error page
        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

   

    #===================================================
    # TURIN.iotserver.uz
    #--------------------------------------------------
    server {
        listen 80;
        server_name turin.iotserver.uz;
        return 301 https://wokwi.com/projects/408704440273711105;
    }

    server {
        listen 443 ssl;
        # http2 on;
        server_name turin.iotserver.uz;

        ssl_certificate /etc/letsencrypt/live/iotserver.uz/fullchain.pem; # SSL Certificate
        ssl_certificate_key /etc/letsencrypt/live/iotserver.uz/privkey.pem; # SSL Certificate Key

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        return 301 https://wokwi.com/projects/408704440273711105;
    }


    #===================================================
    # ORANGE.iotserver.uz
    #--------------------------------------------------
    # New server block for orange.webserver.uz
    server {
        listen 443 ssl;
        server_name orange.iotserver.uz;

        ssl_certificate /etc/letsencrypt/live/iotserver.uz/fullchain.pem; # SSL Certificate
        ssl_certificate_key /etc/letsencrypt/live/iotserver.uz/privkey.pem; # SSL Certificate Key

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://172.17.0.1:11200; # Forward requests to port 11200 on the host
            # proxy_pass http://localhost:11200; # Forward requests to port 11200 on the host
            # proxy_pass http://waterlevel:3002;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "close";
            keepalive_timeout 0;
        }

        error_page 502 503 504 =501 /custom_50x;

        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

    #--------------------------------------------------
    server {
        listen 80;
        server_name orange.iotserver.uz;

        location / {
            proxy_pass http://172.17.0.1:11200; # Forward requests to port 11200 on the host
            # proxy_pass http://localhost:11200; # Forward requests to port 11200 on the host
            # proxy_pass http://waterlevel:3002;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "close";
            keepalive_timeout 0;
        }

        # Define a custom error page for 502, 503, and 504 errors
        error_page 502 503 504 =501 /custom_50x;

        # This location block is used to handle the custom error page
        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

    #===================================================
    # InfluxDB Reverse Proxy Configuration
    #--------------------------------------------------
    server {
        listen 443 ssl;
        server_name influxdb.iotserver.uz;  # Adjust as necessary

        ssl_certificate /etc/letsencrypt/live/iotserver.uz/fullchain.pem;  # SSL Certificate
        ssl_certificate_key /etc/letsencrypt/live/iotserver.uz/privkey.pem;  # SSL Certificate Key

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        location / {
            # proxy_pass http://influxdb:8086;  # Redirect requests to the InfluxDB container
            # proxy_pass http://localhost:8086;  # Redirect requests to the InfluxDB container
            proxy_pass http://172.17.0.1:8086;  # Redirect requests to the InfluxDB container
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "close";
            keepalive_timeout 0;
        }

        # Define a custom error page for 502, 503, and 504 errors
        error_page 502 503 504 =501 /custom_50x;

        # This location block is used to handle the custom error page
        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

    #===================================================
    # MySQL phpMyadmin Reverse Proxy Configuration
    #--------------------------------------------------
    server {
        listen 443 ssl;
        server_name mysql.iotserver.uz;  # Adjust as necessary

        ssl_certificate /etc/letsencrypt/live/iotserver.uz/fullchain.pem;  # SSL Certificate
        ssl_certificate_key /etc/letsencrypt/live/iotserver.uz/privkey.pem;  # SSL Certificate Key

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://phpmyadmin:80;  # Redirect requests to the InfluxDB container
            # proxy_pass http://localhost:9090;  # Redirect requests to the InfluxDB container
            # proxy_pass http://172.17.0.1:9090;  # Redirect requests to the InfluxDB container
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "close";
            keepalive_timeout 0;
        }

        # Define a custom error page for 502, 503, and 504 errors
        error_page 502 503 504 =501 /custom_50x;

        # This location block is used to handle the custom error page
        location = /custom_50x {
            return 501;
        }

        location = /favicon.ico {
            root /usr/share/nginx/html; # Ensure this matches your configuration
        }
    }

    
}
